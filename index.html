<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Word Serial Lab</title>

  <!-- === libs (CDN) === -->
  <script src="https://cdn.jsdelivr.net/npm/wanakana@5.0.2/dist/wanakana.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app">
    <header>
      <div>
        <h1>Word Serial Lab</h1>
        <div class="subtitle">Bag → Operation → New Bag | JSON ロード / 正規化 / 集合演算 / 編集</div>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar card">
        <nav class="tabs">
          <button class="btn tab-button active" data-tab="import">Import</button>
          <button class="btn tab-button" data-tab="operations">Operations</button>
          <button class="btn tab-button" data-tab="export">Export</button>
        </nav>

        <section class="tab-panel active" data-panel="import">
          <h3>0) 入力データ</h3>
          <!-- general description removed -->
          <div class="panel-grid">
            <div>
              <div class="muted small" style="margin-bottom:4px;">1) サーバー上のプリセットから選択</div>
              <div class="inline">
                <span class="muted small" style="padding: 0 8px;">デフォルトバッグ:</span>
                <select id="selFile" class="input" style="min-width:220px"></select>
                <button id="btnLoad" class="btn primary">選択 JSON を Bag 化</button>
              </div>
            </div>
            <div>
              <div class="muted small" style="margin-bottom:4px;">2) ローカルの JSON ファイルを読み込み</div>
              <div class="inline" style="display: flex; align-items: center; gap: 10px;">
                <input type="file" id="filePick" accept=".json" style="display: none" />
                <button id="btnFileSelect" class="btn">ローカル JSON を選択</button>
              </div>
              <div class="muted small" style="margin-top:4px;">JSON 形式： <span
                  class="mono">[{"id":"…","lemmas":["語1","語2"],"glosses":[…]}]</span>（lemmas を単語として取り込み）</div>
            </div>
            <div>
              <div class="muted small" style="margin-bottom:4px;">3) テキスト貼り付けから作成</div>
              <input id="bagNameInput" class="input" placeholder="Bag 名（省略可）" />
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <textarea id="pasteArea" rows="8" class="mono" placeholder="一行に一語（任意）"></textarea>
                <button id="btnMakeBagFromText" class="btn">貼り付けテキストからBag化</button>
              </div>
            </div>
            <div id="importLog" class="muted mono small"></div>
          </div>
        </section>

        <section class="tab-panel" data-panel="operations">
          <h3>1) 操作</h3>
          <div class="panel-grid">
            <div class="op-group">
              <h4>かな正規化</h4>
              <p class="muted small" style="margin: 4px 0 8px;">ひらがな・カタカナの正規化や相互変換を行います。</p>
              <select id="selSrcNorm" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <button id="btnNorm" class="btn ok"
                  title="選択したBagの単語をすべてひらがなに変換します (Kuroshiro / WanaKana使用)">ひらがな化</button>
                <button id="btnKatakana" class="btn" title="選択したBagの単語をすべてカタカナに変換します">カタカナ化</button>
              </div>
            </div>

            <div class="op-group">
              <h4>文字変換</h4>
              <p class="muted small" style="margin: 4px 0 8px;">ローマ字変換やケース変換、反転などを行います。</p>
              <select id="selSrcTransform" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <button id="btnRomaji" class="btn" title="ひらがな・カタカナをローマ字に変換します">ローマ字化</button>
                <button id="btnUpper" class="btn" title="アルファベットを大文字に変換します">大文字化</button>
                <button id="btnLower" class="btn" title="アルファベットを小文字に変換します">小文字化</button>
                <button id="btnReverse" class="btn" title="文字列を逆順にします (例: あいう→ういあ)">反転</button>
              </div>
            </div>

            <div class="op-group">
              <h4>文字付与 (Appender)</h4>
              <p class="muted small" style="margin: 4px 0 8px;">全ての単語の先頭や末尾に、指定した文字列を付与します。</p>
              <select id="selSrcAppend" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <input id="appendPrefix" class="input" placeholder="prefix" title="先頭につける文字列" />
                <input id="appendSuffix" class="input" placeholder="suffix" title="末尾につける文字列" />
                <button id="btnAppend" class="btn" title="付与を実行します">付与</button>
              </div>
            </div>

            <div class="op-group">
              <h4>アナグラム</h4>
              <p class="muted small" style="margin: 4px 0 8px;">単語内の文字の並び順をランダムに入れ替えます。</p>
              <select id="selSrcAnagram" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <button id="btnAnagram" class="btn" title="文字をシャッフルします">シャッフル</button>
              </div>
            </div>

            <div class="op-group">
              <h4>文字削除</h4>
              <p class="muted small" style="margin: 4px 0 8px;">指定した文字を単語から削除します。</p>
              <select id="selSrcDel" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <input id="delChars" class="input" placeholder="削除する文字（例：ん）" title="削除したい文字を入力してください" />
                <label class="muted small" title="入力欄の文字をひらがな化してから処理に使用します"><input type="checkbox" id="ckNormDel"
                    checked /> 入力をひらがな化</label>
                <label class="muted small" title="処理前に入力Bagの内容をひらがな化します"><input type="checkbox" id="ckPreNormDel"> Bag
                  をひらがな化</label>
                <button id="btnDel" class="btn warn" title="指定した文字を各単語から削除します">delete chars</button>
              </div>
            </div>

            <div class="op-group">
              <h4>集合演算</h4>
              <p class="muted small" style="margin: 4px 0 8px;">2つのBag間で和・差・積・対称差の集合演算を行います。</p>
              <div class="inline">
                <select id="selSrcUnionA" class="input" title="Bag A を選択"></select>
                <select id="selSrcUnionB" class="input" title="Bag B を選択"></select>
              </div>
              <div class="inline">
                <button id="btnUnion" class="btn" title="AとBの和集合を作成します (A ∪ B)">和集合 (Union)</button>
                <button id="btnDiff" class="btn" title="AからBに含まれる要素を除いた差集合を作成します (A - B)">差集合 (Difference)</button>
                <button id="btnIntersect" class="btn" title="AとBの両方に含まれる要素の積集合を作成します (A ∩ B)">積集合
                  (Intersection)</button>
                <button id="btnSymDiff" class="btn" title="AまたはBの片方だけに含まれる要素の集合を作成します (A △ B)">対称差 (Symmetric)</button>
              </div>
            </div>


            <div class="op-group">
              <h4>結合・直積 (Cartesian)</h4>
              <p class="muted small" style="margin: 4px 0 8px;">2つのBagの全ての組み合わせを結合します (A × B)。</p>
              <div class="inline">
                <select id="selSrcCartesianA" class="input" title="Bag A (Prefix側) を選択"></select>
                <select id="selSrcCartesianB" class="input" title="Bag B (Suffix側) を選択"></select>
              </div>
              <div class="inline">
                <input id="cartesianJoiner" class="input tight" placeholder="連結文字 (なし)" title="間に挟む文字 (例: の, -)" />
                <label class="muted small">Limit <input id="cartesianLimit" type="number" min="1" class="input tight"
                    value="10000" title="生成数の上限 (安全のため)"></label>
                <button id="btnCartesian" class="btn" title="直積結合を実行します">結合 (Join)</button>
              </div>
            </div>

            <div class="op-group">
              <h4>包含フィルタ</h4>
              <p class="muted small" style="margin: 4px 0 8px;">辞書（Lookup Bag）に含まれる単語のみを残します。</p>
              <div class="inline">
                <select id="selSrcFlt" class="input" title="フィルタ対象のBagを選択"></select>
                <select id="selLkpFlt" class="input" title="辞書として使うBagを選択"></select>
                <button id="btnFlt" class="btn" title="辞書Bagに含まれている単語だけを残します">filter_in（交差）</button>
              </div>
              <div class="inline">
                <label class="muted small" title="処理前に対象Bagをひらがな化します"><input type="checkbox" id="ckPreNormFltSrc"> Bag
                  をひらがな化</label>
                <label class="muted small" title="処理前に辞書Bagをひらがな化します"><input type="checkbox" id="ckPreNormFltLookup">
                  Lookup をひらがな化</label>
              </div>
            </div>

            <div class="op-group">
              <h4>長さフィルタ</h4>
              <p class="muted small" style="margin: 4px 0 8px;">文字数が指定範囲内の単語のみを抽出します。</p>
              <select id="selSrcLen" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <label class="muted small">min <input id="lenMin" type="number" min="0" class="input tight" value="1"
                    title="最小文字数"></label>
                <label class="muted small">max <input id="lenMax" type="number" min="1" class="input tight" value="10"
                    title="最大文字数"></label>
                <button id="btnLengthFilter" class="btn" title="指定した長さの範囲内の単語を抽出します">適用</button>
              </div>
              <div class="inline">
                <label class="muted small" title="処理前に入力Bagをひらがな化します"><input type="checkbox" id="ckPreNormLen"> Bag
                  をひらがな化</label>
              </div>
            </div>

            <div class="op-group">
              <h4>前後一致フィルタ</h4>
              <p class="muted small" style="margin: 4px 0 8px;">前方一致（接頭辞）または後方一致（接尾辞）でフィルタします。</p>
              <select id="selSrcAffix" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <label class="muted small" title="処理前に入力Bagをひらがな化します"><input type="checkbox" id="ckPreNormAffix"> Bag
                  をひらがな化</label>
              </div>
              <div class="inline">
                <input id="prefixValue" class="input" placeholder="前方一致（prefix）" title="開始文字列を指定" />
                <button id="btnPrefix" class="btn" title="指定した文字列で始まる単語を抽出します">prefix filter</button>
              </div>
              <div class="inline">
                <input id="suffixValue" class="input" placeholder="後方一致（suffix）" title="終了文字列を指定" />
                <button id="btnSuffix" class="btn" title="指定した文字列で終わる単語を抽出します">suffix filter</button>
              </div>
            </div>

            <div class="op-group">
              <h4>部分一致フィルタ</h4>
              <p class="muted small" style="margin: 4px 0 8px;">指定した文字列を含む単語を抽出します。</p>
              <select id="selSrcContains" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <label class="muted small" title="処理前に入力Bagをひらがな化します"><input type="checkbox" id="ckPreNormContains"> Bag
                  をひらがな化</label>
              </div>
              <div class="inline">
                <input id="containsValue" class="input" placeholder="入力文字列を含む語" title="検索したい文字列" />
                <button id="btnContains" class="btn" title="指定した文字列を含む単語を抽出します">contains filter</button>
              </div>
            </div>

            <div class="op-group">
              <h4>正規表現フィルタ</h4>
              <p class="muted small" style="margin: 4px 0 8px;">正規表現パターンにマッチする単語を抽出します。</p>
              <select id="selSrcRegex" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <input id="regexPattern" class="input" placeholder="例：^[ぁ-ゔ]{2,3}$" title="正規表現パターンを入力" />
                <label class="muted small" title="マッチしないものを抽出する場合にチェック"><input type="checkbox" id="regexInvert">
                  逆一致</label>
                <button id="btnRegex" class="btn" title="正規表現でフィルタします">filter_regex</button>
              </div>
              <div class="inline">
                <label class="muted small" title="処理前に入力Bagをひらがな化します"><input type="checkbox" id="ckPreNormRegex"> Bag
                  をひらがな化</label>
              </div>
            </div>

            <div class="op-group">
              <h4>類似度フィルタ (Levenshtein)</h4>
              <p class="muted small" style="margin: 4px 0 8px;">ターゲット文字列に近い単語（編集距離が近い）を抽出します。</p>
              <select id="selSrcSimilarity" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <input id="similarityTarget" class="input" placeholder="ターゲット文字列" title="比較対象の単語" />
                <label class="muted small">dist <input id="similarityDist" type="number" min="0" class="input tight"
                    value="2" title="許容する最大編集距離"></label>
                <button id="btnSimilarity" class="btn" title="類似度フィルタを実行します">抽出</button>
              </div>
              <div class="inline">
                <label class="muted small" title="処理前に入力Bagをひらがな化します"><input type="checkbox" id="ckPreNormSimilarity">
                  Bag
                  をひらがな化</label>
              </div>
            </div>

            <div class="op-group">
              <h4>整形・置換</h4>
              <p class="muted small" style="margin: 4px 0 8px;">重複文字除去、置換、ソートを行います。</p>
              <select id="selSrcFormat" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <button id="btnDedupe" class="btn" title="各単語内で重複する文字を取り除きます">重複文字除去</button>
                <button id="btnSortAsc" class="btn" title="単語を辞書順（昇順）に並べます">昇順ソート</button>
                <button id="btnSortDesc" class="btn" title="単語を辞書順（降順）に並べます">降順ソート</button>
              </div>
              <div class="inline">
                <input id="replaceFrom" class="input" placeholder="置換 from" title="置換されれる文字列" />
                <input id="replaceTo" class="input" placeholder="to" title="置換後の文字列" />
                <button id="btnReplace" class="btn" title="文字列置換を実行します">置換</button>
              </div>
            </div>

            <div class="op-group">
              <h4>n-gram 抽出</h4>
              <p class="muted small" style="margin: 4px 0 8px;">単語からN文字ごとの切り出しを行い、新しいBagを作ります。</p>
              <select id="selSrcNgram" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <label class="muted small">n <input id="ngramN" type="number" min="1" class="input tight" value="2"
                    title="切り出す文字数"></label>
                <button id="btnNgram" class="btn" title="N-gram抽出を実行します">抽出</button>
              </div>
            </div>

            <div class="op-group">
              <h4>サンプリング</h4>
              <p class="muted small" style="margin: 4px 0 8px;">Bagからランダムに指定数を抽出します。</p>
              <select id="selSrcSample" class="input" title="入力とするBagを選択"></select>
              <div class="inline">
                <label class="muted small">count <input id="sampleCount" type="number" min="1" class="input tight"
                    value="20" title="抽出数"></label>
                <input id="sampleSeed" class="input" placeholder="seed（任意）" title="乱数シード（固定すると再現性が出ます）" />
                <button id="btnSample" class="btn" title="ランダムサンプリングを実行します">sample</button>
              </div>
            </div>
          </div>
        </section>

        <section class="tab-panel" data-panel="export">
          <h3>2) Export</h3>
          <div class="panel-grid">
            <select id="selExport" class="input"></select>
            <div class="export-actions">
              <button class="btn" data-format="txt">TXT</button>
              <button class="btn" data-format="csv">CSV</button>
              <button class="btn primary" data-format="json">JSON</button>
            </div>
            <div class="muted small">選択した Bag をダウンロードします。CSV では 1 行に 1 語、JSON では <span class="mono">{"name":…,
                "items":[…]}</span> を出力。</div>
          </div>
        </section>
      </aside>

      <main class="main card">
        <div>
          <h2>Bag 一覧</h2>
          <div class="subtitle small">プレビューを開くと編集・コピーができます。</div>
        </div>
        <button id="btnApplyAll" class="btn ok">全バッグを再適用</button>
        <div id="bagsArea" class="bag-list"></div>
      </main>

      <aside class="log-panel card">
        <div class="log-header">
          <h3>操作履歴</h3>
          <div class="history-actions">
            <button id="btnUndo" class="btn ghost" disabled>Undo</button>
            <button id="btnRedo" class="btn ghost" disabled>Redo</button>
          </div>
        </div>
        <div id="opLog" class="log-body"></div>
        <div>
          <h3>ログ</h3>
        </div>
        <div id="log" class="log-body"></div>
      </aside>
    </div>
  </div>

  <script src="utils.js" type="module"></script>
  <script src="models.js" type="module"></script>
  <script src="operations.js" type="module"></script>
  <script src="app.js" type="module"></script>
</body>

</html>