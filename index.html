<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word Serial Lab</title>

<!-- === libs (CDN) === -->
<script src="https://cdn.jsdelivr.net/npm/wanakana@5.0.2/dist/wanakana.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

<style>
  :root {
    --bg: #0f1115;
    --fg: #e6e6e6;
    --muted: #9aa0a6;
    --acc: #7aa2f7;
    --warn: #f6bd60;
    --ok: #34d399;
    --err: #f06272;
    --card: #151a22;
    --border: #2a2f3a;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--fg);
    font: 14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", sans-serif;
  }
  h1, h2, h3, h4 { margin: 0; font-weight: 700; }
  h1 { font-size: 24px; }
  h2 { font-size: 18px; }
  h3 { font-size: 16px; margin-bottom: 8px; }
  .app {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px 24px 32px;
  }
  .app > header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 18px;
    gap: 12px;
    flex-wrap: wrap;
  }
  .subtitle { color: var(--muted); font-size: 13px; }
  .layout {
    display: grid;
    grid-template-columns: 320px minmax(0, 1fr) 280px;
    gap: 18px;
  }
  @media (max-width: 1200px) {
    .layout { grid-template-columns: minmax(0, 1fr); }
    .sidebar, .main, .log-panel { order: initial; }
  }
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
  }
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 480px;
  }
  .bag-list { display: flex; flex-direction: column; gap: 12px; }
  .bag-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    background: rgba(15, 20, 30, 0.6);
    overflow: hidden;
  }
  .bag-card > summary {
    cursor: pointer;
    padding: 10px 12px;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .bag-card > summary::-webkit-details-marker { display: none; }
  .bag-title { font-size: 14px; font-weight: 600; }
  .bag-meta {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 12px;
    color: var(--muted);
    padding: 0 12px 12px;
    white-space: pre-wrap;
  }
  .preview-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 0 12px 10px;
    align-items: center;
  }
  .preview-bar label { display: flex; gap: 4px; align-items: center; color: var(--muted); }
  .preview {
    width: 100%;
    border: none;
    border-top: 1px solid var(--border);
    padding: 12px;
    background: rgba(8, 10, 16, 0.6);
    color: var(--fg);
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    resize: vertical;
  }
  .btn {
    cursor: pointer;
    background: #1e2530;
    border: 1px solid var(--border);
    color: var(--fg);
    padding: 7px 12px;
    border-radius: 10px;
    transition: all 0.15s ease;
    font-weight: 600;
  }
  .btn:hover { border-color: var(--acc); box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.15) inset; }
  .btn.primary { background: linear-gradient(180deg, #1f2a44, #1a2136); border-color: #304571; color: #e7efff; }
  .btn.warn { background: #3a2a17; border-color: #6b4d27; color: #ffe7ba; }
  .btn.ok { background: #11261f; border-color: #1f6b53; color: #cafdf0; }
  .btn.ghost { background: transparent; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; border-color: var(--border); }
  .input, textarea, select {
    width: 100%;
    padding: 8px 10px;
    color: var(--fg);
    background: #10151e;
    border: 1px solid var(--border);
    border-radius: 10px;
    outline: none;
  }
  textarea { resize: vertical; }
  .muted { color: var(--muted); }
  .small { font-size: 12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .tight { max-width: 200px; }
  .tabs { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .tab-button {
    border-radius: 999px;
    padding: 8px 16px;
    border: 1px solid transparent;
    background: rgba(16, 21, 30, 0.6);
    color: var(--muted);
  }
  .tab-button.active {
    color: var(--fg);
    background: rgba(122, 162, 247, 0.18);
    border-color: rgba(122, 162, 247, 0.4);
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  .panel-grid { display: grid; gap: 12px; }
  .grid { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
  .log-panel { display: flex; flex-direction: column; gap: 16px; min-height: 480px; }
  .log-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  .log-body { background: rgba(8, 10, 16, 0.55); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; height: 200px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color: var(--muted); }
  .log-entry + .log-entry { margin-top: 6px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; background: rgba(122,162,247,0.15); color: var(--acc); }
  .op-group { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: rgba(15, 20, 30, 0.6); display: grid; gap: 10px; }
  .op-group h4 { font-size: 14px; margin: 0; }
  .inline { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .inline .input { max-width: 160px; }
  .history-actions { display: flex; gap: 8px; }
  .export-actions { display: flex; gap: 10px; flex-wrap: wrap; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Word Serial Lab</h1>
      <div class="subtitle">Bag → Operation → New Bag | JSON ロード / 正規化 / 集合演算 / 編集</div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar card">
      <div>
        <h2>Bag 一覧</h2>
        <div class="subtitle small">プレビューを開くと編集・コピーができます。</div>
      </div>
      <div id="bagsArea" class="bag-list"></div>
    </aside>

    <main class="main card">
      <nav class="tabs">
        <button class="btn tab-button active" data-tab="import">Import</button>
        <button class="btn tab-button" data-tab="operations">Operations</button>
        <button class="btn tab-button" data-tab="export">Export</button>
      </nav>

      <section class="tab-panel active" data-panel="import">
        <h3>0) 入力データ</h3>
        <div class="panel-grid">
          <div class="inline">
            <button id="btnList" class="btn">bag/ を列挙</button>
            <select id="selFile" class="input" style="min-width:220px"></select>
            <button id="btnLoad" class="btn primary">選択 JSON を Bag 化</button>
          </div>
          <div class="inline">
            <span class="muted small">または</span>
            <input type="file" id="filePick" class="input" accept=".json" />
          </div>
          <div class="muted small">JSON 形式： <span class="mono">[{"id":"…","lemmas":["語1","語2"],"glosses":[…]}]</span>（lemmas を単語として取り込み）</div>
          <div class="grid">
            <textarea id="pasteArea" rows="8" class="mono" placeholder="一行に一語（任意）"></textarea>
            <button id="btnMakeBagFromText" class="btn">貼り付け → Bag</button>
          </div>
          <div class="grid">
            <input id="bagNameInput" class="input" placeholder="Bag 名（省略可）" />
            <div></div>
          </div>
          <div id="importLog" class="muted mono small"></div>
        </div>
      </section>

      <section class="tab-panel" data-panel="operations">
        <h3>1) 操作</h3>
        <div class="panel-grid">
          <div class="op-group">
            <h4>かな正規化</h4>
            <select id="selSrcNorm" class="input"></select>
            <div class="inline">
              <button id="btnNorm" class="btn ok">ひらがな化</button>
              <button id="btnKatakana" class="btn">カタカナ化</button>
            </div>
          </div>

          <div class="op-group">
            <h4>文字削除</h4>
            <select id="selSrcDel" class="input"></select>
            <div class="inline">
              <input id="delChars" class="input" placeholder="削除する文字（例：ん）" />
              <label class="muted small"><input type="checkbox" id="ckNormDel" checked /> 入力をひらがな化</label>
              <button id="btnDel" class="btn warn">delete chars</button>
            </div>
          </div>

          <div class="op-group">
            <h4>集合演算</h4>
            <div class="inline">
              <select id="selSrcUnionA" class="input"></select>
              <select id="selSrcUnionB" class="input"></select>
            </div>
            <div class="inline">
              <button id="btnUnion" class="btn">和集合 (Union)</button>
              <button id="btnDiff" class="btn">差集合 (Difference)</button>
            </div>
          </div>

          <div class="op-group">
            <h4>包含フィルタ</h4>
            <div class="inline">
              <select id="selSrcFlt" class="input"></select>
              <select id="selLkpFlt" class="input"></select>
              <button id="btnFlt" class="btn">filter_in（交差）</button>
            </div>
          </div>

          <div class="op-group">
            <h4>長さフィルタ</h4>
            <select id="selSrcLen" class="input"></select>
            <div class="inline">
              <label class="muted small">min <input id="lenMin" type="number" min="0" class="input tight" value="1"></label>
              <label class="muted small">max <input id="lenMax" type="number" min="1" class="input tight" value="10"></label>
              <button id="btnLengthFilter" class="btn">適用</button>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="export">
        <h3>2) Export</h3>
        <div class="panel-grid">
          <select id="selExport" class="input"></select>
          <div class="export-actions">
            <button class="btn" data-format="txt">TXT</button>
            <button class="btn" data-format="csv">CSV</button>
            <button class="btn primary" data-format="json">JSON</button>
          </div>
          <div class="muted small">選択した Bag をダウンロードします。CSV では 1 行に 1 語、JSON では <span class="mono">{"name":…, "items":[…]}</span> を出力。</div>
        </div>
      </section>
    </main>

    <aside class="log-panel card">
      <div class="log-header">
        <h3>操作履歴</h3>
        <div class="history-actions">
          <button id="btnUndo" class="btn ghost" disabled>Undo</button>
          <button id="btnRedo" class="btn ghost" disabled>Redo</button>
        </div>
      </div>
      <div id="opLog" class="log-body"></div>
      <div>
        <h3>ログ</h3>
      </div>
      <div id="log" class="log-body"></div>
    </aside>
  </div>
</div>

<script>
/* ====== 共通ユーティリティ ====== */
const nowISO = () => new Date().toISOString().replace(/\.\d{3}Z$/, 'Z');
const uniq = a => Array.from(new Set(a));
const normNFKC = s => (s || "").normalize('NFKC').trim();
const el = q => document.querySelector(q);
function log(msg) {
  const host = el('#log');
  if (!host) return;
  const div = document.createElement('div');
  div.className = 'log-entry';
  div.textContent = `[${nowISO()}] ${msg}`;
  host.prepend(div);
  while (host.children.length > 150) host.removeChild(host.lastChild);
}
function appendOpLog(msg) {
  const host = el('#opLog');
  if (!host) return;
  const div = document.createElement('div');
  div.className = 'log-entry';
  div.textContent = `[${nowISO()}] ${msg}`;
  host.prepend(div);
  while (host.children.length > 150) host.removeChild(host.lastChild);
}
function setSelectOptions(sel, opts) {
  if (!sel) return;
  const v = sel.value;
  sel.innerHTML = '';
  for (const o of opts) {
    const op = document.createElement('option');
    op.value = o.value;
    op.textContent = o.label;
    sel.appendChild(op);
  }
  if (opts.length) {
    sel.value = v && opts.some(o => o.value === v) ? v : opts[opts.length - 1].value;
  }
}

/* ====== Kuroshiro（かな正規化） ====== */
let K = null, kuroReady = false;
async function ensureKuro() {
  if (kuroReady) return;
  K = new window.Kuroshiro();
  const Analyzer = window.Kuroshiro.Analyzer.KuromojiAnalyzer;
  await K.init(new Analyzer({ dictPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict' }));
  kuroReady = true;
}
async function toHiragana(s) {
  if (!s) return '';
  try {
    await ensureKuro();
    return await K.convert(normNFKC(s), { to: 'hiragana', mode: 'spaced' });
  } catch {
    return window.wanakana.toHiragana(normNFKC(s));
  }
}
async function toKatakana(s) {
  if (!s) return '';
  try {
    await ensureKuro();
    return await K.convert(normNFKC(s), { to: 'katakana', mode: 'spaced' });
  } catch {
    return window.wanakana.toKatakana(normNFKC(s));
  }
}

/* ====== Bag / Registry ====== */
let _nextId = 0;
class Bag {
  constructor(name, items, meta = {}) {
    this.id = _nextId++;
    this.name = name || `bag#${this.id}`;
    this.items = new Set(items || []);
    this.meta = Object.assign({}, meta);
    if (!this.meta.created_at) this.meta.created_at = nowISO();
    this.meta.size = this.items.size;
  }
  label() { return `[${this.id}] ${this.name} (${this.items.size})`; }
}
class BagRegistry {
  constructor() { this._bags = []; }
  add(b) { this._bags.push(b); return b.id; }
  get(id) { return this._bags.find(x => x.id === Number(id)); }
  all() { return this._bags.slice(); }
  choices() { return this._bags.map(b => ({ label: b.label(), value: String(b.id) })); }
  serialize() {
    return {
      nextId: _nextId,
      bags: this._bags.map(b => ({
        id: b.id,
        name: b.name,
        items: Array.from(b.items),
        meta: Object.assign({}, b.meta)
      }))
    };
  }
  restore(snapshot) {
    this._bags = snapshot.bags.map(data => {
      const bag = new Bag(data.name, data.items, Object.assign({}, data.meta));
      bag.id = data.id;
      bag.meta.size = bag.items.size;
      return bag;
    });
    _nextId = snapshot.nextId;
  }
}
const REG = new BagRegistry();

/* ====== 履歴管理 ====== */
const history = [];
let historyIndex = -1;
function captureState() {
  const snapshot = REG.serialize();
  history.splice(historyIndex + 1);
  history.push(snapshot);
  historyIndex = history.length - 1;
  updateUndoRedoButtons();
}
function restoreFromHistory() {
  if (historyIndex < 0 || historyIndex >= history.length) return;
  const snapshot = history[historyIndex];
  REG.restore(snapshot);
  renderBags();
  applyChoices();
  updateUndoRedoButtons();
}
function updateUndoRedoButtons() {
  const undoBtn = el('#btnUndo');
  const redoBtn = el('#btnRedo');
  if (undoBtn) undoBtn.disabled = historyIndex <= 0;
  if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
}
function initHistory() {
  captureState();
}

/* ====== Ops（シリアル） ====== */
async function op_normalize_hiragana(srcBag) {
  const out = new Set();
  let i = 0;
  for (const w of srcBag.items) {
    const h = await toHiragana(w);
    if (h) out.add(h.replace(/\s+/g, ''));
    if (++i % 2000 === 0) await new Promise(r => setTimeout(r, 0));
  }
  return new Bag(`${srcBag.name} → normalize(hiragana)`, out, { op: 'normalize_hiragana', src: srcBag.id, normalized: 'hiragana' });
}
async function op_normalize_katakana(srcBag) {
  const out = new Set();
  let i = 0;
  for (const w of srcBag.items) {
    const h = await toKatakana(w);
    if (h) out.add(h.replace(/\s+/g, ''));
    if (++i % 2000 === 0) await new Promise(r => setTimeout(r, 0));
  }
  return new Bag(`${srcBag.name} → normalize(katakana)`, out, { op: 'normalize_katakana', src: srcBag.id, normalized: 'katakana' });
}
async function op_delete_chars(srcBag, chars, normalizeInput = false) {
  const del = normalizeInput ? await toHiragana(chars) : normNFKC(chars);
  const dels = Array.from(new Set((del || '').split('')));
  const out = new Set();
  for (const w of srcBag.items) {
    let wNew = w;
    for (const c of dels) if (c) wNew = wNew.split(c).join('');
    if (wNew !== w) out.add(wNew);
  }
  return new Bag(`${srcBag.name} → delete(${dels.join('') || '∅'})`, out, { op: 'delete_chars', src: srcBag.id, deleted: dels.join('') });
}
function op_filter_in(srcBag, lookupBag) {
  const out = new Set();
  for (const w of srcBag.items) if (lookupBag.items.has(w)) out.add(w);
  return new Bag(`${srcBag.name} → filter_in([${lookupBag.id}:${lookupBag.name}])`, out, { op: 'filter_in', src: srcBag.id, lookup: lookupBag.id });
}
function op_union(bagA, bagB) {
  const out = new Set([...bagA.items, ...bagB.items]);
  return new Bag(`${bagA.name} ∪ ${bagB.name}`, out, { op: 'union', src: [bagA.id, bagB.id].join(','), size_a: bagA.items.size, size_b: bagB.items.size });
}
function op_difference(bagA, bagB) {
  const out = new Set([...bagA.items].filter(w => !bagB.items.has(w)));
  return new Bag(`${bagA.name} - ${bagB.name}`, out, { op: 'difference', src: [bagA.id, bagB.id].join(','), size_a: bagA.items.size, size_b: bagB.items.size });
}
function op_filter_length(bag, minLen, maxLen) {
  const out = new Set();
  for (const w of bag.items) {
    const len = normNFKC(w).length;
    if (len >= minLen && len <= maxLen) out.add(w);
  }
  return new Bag(`${bag.name} → length[${minLen}-${maxLen}]`, out, { op: 'filter_length', src: bag.id, range: `${minLen}-${maxLen}` });
}

/* ====== JSON列挙・ロード（bag/*.json） ====== */
const BAG_DIR = './bag/';
function applyChoices() {
  const choices = REG.choices();
  const ids = ['#selSrcNorm', '#selSrcDel', '#selSrcFlt', '#selLkpFlt', '#selSrcUnionA', '#selSrcUnionB', '#selSrcLen', '#selExport'];
  ids.forEach(id => setSelectOptions(el(id), choices));
}
function addBagFromWords(name, words, meta) {
  const b = new Bag(name, uniq(words.map(normNFKC).filter(Boolean)), meta || {});
  REG.add(b);
  applyChoices();
  renderBags();
  captureState();
  appendOpLog(`+ Bag [${b.id}] '${b.name}' size=${b.items.size}`);
  return b;
}

async function listJson() {
  const sel = el('#selFile');
  if (!sel) return;
  sel.innerHTML = '';
  try {
    const r = await fetch(BAG_DIR + '_files.txt', { cache: 'no-cache' });
    if (r.ok) {
      const t = await r.text();
      const files = t.split(/\r?\n/).map(s => s.trim()).filter(s => s && /\.json$/i.test(s));
      if (files.length) {
        setSelectOptions(sel, files.map(f => ({ label: f, value: f })));
        log('一覧: _files.txt から ' + files.length + ' 件');
        return;
      }
    }
  } catch (_) {}
  try {
    const r = await fetch(BAG_DIR, { cache: 'no-cache' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const html = await r.text();
    const files = [...html.matchAll(/href="([^"]+?\.json)"/gi)].map(m => decodeURIComponent(m[1].split('/').pop()));
    const files2 = [...html.matchAll(/href='([^']+?\.json)'/gi)].map(m => decodeURIComponent(m[1].split('/').pop()));
    const all = uniq([...(files || []), ...(files2 || [])]);
    if (all.length) {
      setSelectOptions(sel, all.map(f => ({ label: f, value: f })));
      log('一覧: ディレクトリ HTML から ' + all.length + ' 件');
      return;
    }
    throw new Error('解析失敗');
  } catch (e) {
    log('列挙失敗: ' + e.message + '（bag/_files.txt を置くか、HTTP サーバのディレクトリ一覧を有効にしろ）');
  }
}
async function loadSelectedJson() {
  const sel = el('#selFile');
  const f = sel && sel.value;
  if (!f) { log('ファイル未選択'); return; }
  try {
    const r = await fetch(BAG_DIR + f, { cache: 'no-cache' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const raw = await r.text();
    const head = raw.trim()[0];
    if (head !== '[' && head !== '{') throw new Error('JSON ではなく HTML 等が返っている');
    const data = JSON.parse(raw);
    const words = [];
    for (const obj of (Array.isArray(data) ? data : [data])) {
      if (obj && Array.isArray(obj.lemmas)) words.push(...obj.lemmas);
    }
    addBagFromWords(f.replace(/\.json$/i, ''), words, { from: 'json', format: 'lemmas' });
    log(`読み込み OK: ${f} | 語数=${words.length}`);
  } catch (e) { log('読み込み失敗: ' + e.message); }
}

/* ====== 手動アップロード / 貼り付け ====== */
el('#filePick')?.addEventListener('change', async (ev) => {
  const f = ev.target.files[0]; if (!f) return;
  try {
    const txt = await f.text();
    const head = txt.trim()[0];
    if (head !== '[' && head !== '{') throw new Error('JSON でない');
    const data = JSON.parse(txt);
    const words = [];
    for (const obj of (Array.isArray(data) ? data : [data])) {
      if (obj && Array.isArray(obj.lemmas)) words.push(...obj.lemmas);
    }
    addBagFromWords(f.name.replace(/\.json$/i, ''), words, { from: 'upload', format: 'lemmas' });
    log(`手動読み込み OK: ${f.name} | 語数=${words.length}`);
  } catch (e) { log('手動読み込み失敗: ' + e.message); }
});
el('#btnMakeBagFromText')?.addEventListener('click', () => {
  const name = normNFKC(el('#bagNameInput').value) || 'input bag';
  const words = uniq(el('#pasteArea').value.split(/\r?\n/).map(s => normNFKC(s)).filter(Boolean));
  if (!words.length) {
    el('#importLog').textContent += (el('#importLog').textContent ? '\n' : '') + '空入力';
    return;
  }
  addBagFromWords(name, words, { from: 'paste', normalized: 'NFKC' });
});

/* ====== 操作ボタン ====== */
el('#btnNorm')?.addEventListener('click', async () => {
  const src = REG.get(el('#selSrcNorm').value); if (!src) return;
  appendOpLog(`normalize(hiragana)… [${src.id}] ${src.name}`);
  const nb = await op_normalize_hiragana(src);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnKatakana')?.addEventListener('click', async () => {
  const src = REG.get(el('#selSrcNorm').value); if (!src) return;
  appendOpLog(`normalize(katakana)… [${src.id}] ${src.name}`);
  const nb = await op_normalize_katakana(src);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnDel')?.addEventListener('click', async () => {
  const src = REG.get(el('#selSrcDel').value); if (!src) return;
  const chars = el('#delChars').value || '';
  const normIn = el('#ckNormDel').checked;
  appendOpLog(`delete chars "${chars}" (normalize_input=${normIn}) … [${src.id}] ${src.name}`);
  const nb = await op_delete_chars(src, chars, normIn);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnFlt')?.addEventListener('click', () => {
  const src = REG.get(el('#selSrcFlt').value), lkp = REG.get(el('#selLkpFlt').value);
  if (!src || !lkp) return;
  appendOpLog(`filter_in lookup=[${lkp.id}:${lkp.name}] … [${src.id}] ${src.name}`);
  const nb = op_filter_in(src, lkp);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnUnion')?.addEventListener('click', () => {
  const a = REG.get(el('#selSrcUnionA').value);
  const b = REG.get(el('#selSrcUnionB').value);
  if (!a || !b) return;
  appendOpLog(`union … [${a.id}] ${a.name} + [${b.id}] ${b.name}`);
  const nb = op_union(a, b);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnDiff')?.addEventListener('click', () => {
  const a = REG.get(el('#selSrcUnionA').value);
  const b = REG.get(el('#selSrcUnionB').value);
  if (!a || !b) return;
  appendOpLog(`difference … [${a.id}] ${a.name} - [${b.id}] ${b.name}`);
  const nb = op_difference(a, b);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});
el('#btnLengthFilter')?.addEventListener('click', () => {
  const src = REG.get(el('#selSrcLen').value);
  if (!src) return;
  const min = Math.max(0, parseInt(el('#lenMin').value || '0', 10));
  const max = Math.max(min, parseInt(el('#lenMax').value || String(min), 10));
  appendOpLog(`filter length [${min}, ${max}] … [${src.id}] ${src.name}`);
  const nb = op_filter_length(src, min, max);
  REG.add(nb); applyChoices(); renderBags(); captureState();
  appendOpLog(`→ NewBag [${nb.id}] size=${nb.items.size}`);
});

/* ====== Export ====== */
function downloadBag(bag, format) {
  if (!bag) return;
  let blob, filename;
  const stamp = nowISO().replace(/[:T-]/g, '').slice(0, 14);
  if (format === 'json') {
    const data = { name: bag.name, id: bag.id, items: Array.from(bag.items) };
    blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    filename = `${bag.name || 'bag'}_${stamp}.json`;
  } else if (format === 'csv') {
    blob = new Blob([Array.from(bag.items).join('\n')], { type: 'text/csv' });
    filename = `${bag.name || 'bag'}_${stamp}.csv`;
  } else {
    blob = new Blob([Array.from(bag.items).join('\n')], { type: 'text/plain' });
    filename = `${bag.name || 'bag'}_${stamp}.txt`;
  }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
  log(`Export ${format.toUpperCase()}: ${filename}`);
}
document.querySelectorAll('.export-actions button').forEach(btn => {
  btn.addEventListener('click', () => {
    const bag = REG.get(el('#selExport').value);
    if (!bag) { log('Export 対象が選択されていません'); return; }
    downloadBag(bag, btn.dataset.format);
  });
});

/* ====== Undo / Redo ====== */
el('#btnUndo')?.addEventListener('click', () => {
  if (historyIndex <= 0) return;
  historyIndex -= 1;
  restoreFromHistory();
  appendOpLog('⮪ Undo');
});
el('#btnRedo')?.addEventListener('click', () => {
  if (historyIndex >= history.length - 1) return;
  historyIndex += 1;
  restoreFromHistory();
  appendOpLog('⮫ Redo');
});

/* ====== Bag一覧（編集/適用 + 範囲/全表示） ====== */
function renderBags() {
  const host = el('#bagsArea');
  if (!host) return;
  host.innerHTML = '';
  for (const b of REG.all()) {
    const details = document.createElement('details');
    details.className = 'bag-card';
    const sum = document.createElement('summary');
    sum.innerHTML = `<div class="bag-title">[${b.id}] ${b.name}</div><div class="muted small">size=${b.items.size} | op=${b.meta.op || 'root'} | norm=${b.meta.normalized || '-'}</div>`;
    details.appendChild(sum);

    const meta = document.createElement('div');
    meta.className = 'bag-meta';
    meta.textContent = Object.entries(b.meta).map(([k, v]) => `${k}: ${v}`).join('\n');
    details.appendChild(meta);

    const bar = document.createElement('div');
    bar.className = 'preview-bar';
    bar.innerHTML = `
      <span class="muted small badge">Preview</span>
      <label class="muted small">offset <input class="input tight" type="number" min="0" value="0" data-k="off"></label>
      <label class="muted small">limit <input class="input tight" type="number" min="1" value="200" data-k="lim"></label>
      <label class="muted small"><input type="checkbox" data-k="all"> 全表示</label>
      <button class="btn ghost" data-k="copy">コピー</button>
      <button class="btn" data-k="edit">編集モード</button>
      <button class="btn ok" data-k="apply" disabled>編集を適用</button>
      <span class="muted mono small" data-k="count"></span>
    `;
    details.appendChild(bar);

    const ta = document.createElement('textarea');
    ta.className = 'preview mono';
    ta.rows = 10;
    ta.readOnly = true;
    details.appendChild(ta);

    const offEl = bar.querySelector('input[data-k="off"]');
    const limEl = bar.querySelector('input[data-k="lim"]');
    const allEl = bar.querySelector('input[data-k="all"]');
    const copyBtn = bar.querySelector('[data-k="copy"]');
    const editBtn = bar.querySelector('[data-k="edit"]');
    const applyBtn = bar.querySelector('[data-k="apply"]');
    const cntEl = bar.querySelector('[data-k="count"]');

    function renderRange() {
      const items = Array.from(b.items).sort((a, c) => a.localeCompare(c, 'ja'));
      cntEl.textContent = `total=${items.length}`;
      let off = Math.max(0, parseInt(offEl.value || 0, 10));
      let lim = Math.max(1, parseInt(limEl.value || 200, 10));
      if (allEl.checked) { off = 0; lim = items.length; }
      ta.value = items.slice(off, off + lim).join('\n');
    }
    offEl.addEventListener('input', renderRange);
    limEl.addEventListener('input', renderRange);
    allEl.addEventListener('change', renderRange);
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(ta.value);
        copyBtn.textContent = 'コピー済み';
        setTimeout(() => copyBtn.textContent = 'コピー', 1200);
      } catch {}
    });

    let editing = false;
    editBtn.addEventListener('click', () => {
      editing = !editing;
      ta.readOnly = !editing;
      editBtn.textContent = editing ? '編集中…' : '編集モード';
      applyBtn.disabled = !editing;
      if (editing) {
        ta.value = Array.from(b.items).sort((a, c) => a.localeCompare(c, 'ja')).join('\n');
      } else {
        renderRange();
      }
    });
    applyBtn.addEventListener('click', () => {
      const lines = ta.value.split(/\r?\n/).map(normNFKC).filter(Boolean);
      b.items = new Set(uniq(lines));
      b.meta.size = b.items.size;
      ta.readOnly = true;
      editing = false;
      applyBtn.disabled = true;
      editBtn.textContent = '編集モード';
      sum.innerHTML = `<div class="bag-title">[${b.id}] ${b.name}</div><div class="muted small">size=${b.items.size} | op=${b.meta.op || 'root'} | norm=${b.meta.normalized || '-'}</div>`;
      renderRange();
      captureState();
      appendOpLog(`edit → Bag [${b.id}] size=${b.items.size}`);
    });

    details.addEventListener('toggle', () => { if (details.open) renderRange(); });

    host.appendChild(details);
  }
}

/* ====== タブ操作 ====== */
document.querySelectorAll('.tab-button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    const target = document.querySelector(`.tab-panel[data-panel="${btn.dataset.tab}"]`);
    if (target) target.classList.add('active');
  });
});

/* ====== 初期化 ====== */
document.getElementById('btnList').onclick = listJson;
document.getElementById('btnLoad').onclick = loadSelectedJson;
initHistory();
(function seed() {
  const demo = ['狐', 'たぬき', '東京', '百科事典', 'コンピュータ', 'がっこう', 'バナナ', 'リンゴ', 'りんご', 'アップル'];
  addBagFromWords('seed (demo few nouns)', demo, { pos: 'n', normalized: 'NFKC only', seed: true });
})();
renderBags();
applyChoices();
</script>
</body>
</html>
